<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Private Chat</title>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: system-ui;
  background: #0b141a;
  color: #fff;
}

/* APP */
#app {
  max-width: 420px;
  height: 100vh;
  margin: auto;
  display: grid;
  grid-template-rows: auto 1fr;
}

/* HEADER */
header {
  background: #075e54;
  padding: 14px;
  font-weight: 600;
  text-align: center;
}

/* JOIN */
#joinBox {
  padding: 16px;
}

input, textarea, button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 8px;
  border: none;
  font-family: inherit;
}

input, textarea {
  background: #1f2c34;
  color: #fff;
  resize: none;
}

button {
  background: #25d366;
  font-weight: 600;
  cursor: pointer;
}

/* CHAT */
#chat {
  display: none;
  height: 100%;
  display: grid;
  grid-template-rows: 1fr auto;
}

/* MESSAGES */
#msgs {
  overflow-y: auto;
  padding: 10px;
}

.msg {
  max-width: 75%;
  padding: 10px;
  margin: 6px 0;
  border-radius: 10px;
  font-size: 14px;
  word-break: break-word;
}

.me {
  background: #dcf8c6;
  color: #000;
  margin-left: auto;
}

.other {
  background: #202c33;
}

/* COMPOSER */
#composer {
  background: #1f2c34;
  padding: 8px;
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 6px;
}

#text {
  min-height: 44px;
  max-height: 120px;
  overflow-y: auto;
}
</style>
</head>

<body>
<div id="app">
  <header id="title">Private Chat</header>

  <!-- JOIN -->
  <div id="joinBox">
    <input id="roomInput" placeholder="Secret key">
    <input id="userInput" placeholder="Username">
    <button id="joinBtn">Join Chat</button>
  </div>

  <!-- CHAT -->
  <div id="chat">
    <div id="msgs"></div>

    <div id="composer">
      <textarea id="text" placeholder="Type a message..."></textarea>
      <button id="sendBtn">âž¤</button>
    </div>
  </div>
</div>

<script>
/* ---------- DOM ---------- */
const roomInput = document.getElementById("roomInput");
const userInput = document.getElementById("userInput");
const joinBox = document.getElementById("joinBox");
const chatBox = document.getElementById("chat");
const msgs = document.getElementById("msgs");
const textInput = document.getElementById("text");
const title = document.getElementById("title");

/* ---------- STATE ---------- */
let ws, roomKey, myName;

/* ---------- MESSAGE ID ---------- */
function msgId() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2);
}

/* ---------- STORAGE ---------- */
function storageKey(room) {
  return "chat-history-" + room;
}

function loadHistory(room) {
  return JSON.parse(localStorage.getItem(storageKey(room)) || "[]");
}

function saveMessage(room, msg) {
  const history = loadHistory(room);

  // prevent duplicates
  if (history.some(m => m.id === msg.id)) return;

  history.push(msg);
  localStorage.setItem(storageKey(room), JSON.stringify(history));
}

/* ---------- UI ---------- */
function addMsg(user, text) {
  const d = document.createElement("div");
  d.className = "msg " + (user === myName ? "me" : "other");
  d.innerHTML = `<b>${user}</b><br>${text}`;
  msgs.appendChild(d);
  msgs.scrollTop = msgs.scrollHeight;
}

/* ---------- JOIN ---------- */
function joinChat() {
  roomKey = roomInput.value.trim();
  myName = userInput.value.trim();
  if (!roomKey || !myName) return alert("Fill all fields");

  ws = new WebSocket(
    `wss://chat-server.skybaseofj2.workers.dev/?room=${encodeURIComponent(roomKey)}`
  );

  ws.onopen = () => {
    joinBox.style.display = "none";
    chatBox.style.display = "grid";
    title.innerText = "Room: " + roomKey;

    // load local history
    loadHistory(roomKey).forEach(m => {
      addMsg(m.user, m.text);
    });
  };

  ws.onmessage = e => {
    const m = JSON.parse(e.data);

    addMsg(m.user, m.text);
    saveMessage(roomKey, m);
  };
}

/* ---------- SEND ---------- */
function sendMsg() {
  if (!textInput.value.trim()) return;

  const msg = {
    id: msgId(),
    user: myName,
    text: textInput.value.trim(),
    time: Date.now()
  };

  ws.send(JSON.stringify(msg));
  textInput.value = "";
}

/* ---------- EVENTS ---------- */
document.getElementById("joinBtn").onclick = joinChat;
document.getElementById("sendBtn").onclick = sendMsg;

textInput.addEventListener("input", () => {
  textInput.style.height = "auto";
  textInput.style.height = textInput.scrollHeight + "px";
});
</script>
</body>
</html>
