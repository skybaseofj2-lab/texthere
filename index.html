<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chat</title>
</head>

<body>
Room: <input id="room"><br><br>
User: <input id="user"><br><br>
<button id="join">Join</button>

<hr>

<div id="chat" style="display:none">
  <div id="msgs" style="height:300px;overflow:auto;border:1px solid #000"></div>
  <input id="text">
  <button id="send">Send</button>
</div>

<script>
let ws;
let room;
let user;

const msgs = document.getElementById("msgs");

function add(u, t) {
  const d = document.createElement("div");
  d.textContent = u + ": " + t;
  msgs.appendChild(d);
}

document.getElementById("join").onclick = async () => {
  room = roomInput.value;
  user = userInput.value;

  document.getElementById("chat").style.display = "block";

  // ðŸ”¹ TRY loading history (non-blocking)
  try {
    const res = await fetch(
      `https://chat-server.skybaseofj2.workers.dev/history?room=${room}`
    );
    const history = await res.json();
    history.forEach(m => add(m.user, m.text));
  } catch (e) {
    console.warn("History load failed, continuing...");
  }

  // ðŸ”¹ ALWAYS connect WebSocket
  ws = new WebSocket(
    `wss://chat-server.skybaseofj2.workers.dev/?room=${room}`
  );

  ws.onopen = () => {
    console.log("SOCKET OPEN");
  };

  ws.onmessage = e => {
    const m = JSON.parse(e.data);
    add(m.user, m.text);
  };
};

document.getElementById("send").onclick = () => {
  if (!ws || ws.readyState !== WebSocket.OPEN) return;

  ws.send(JSON.stringify({
    user,
    text: document.getElementById("text").value,
    time: Date.now()
  }));

  document.getElementById("text").value = "";
};
</script>
</body>
</html>
