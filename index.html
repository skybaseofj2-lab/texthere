<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chat</title>
</head>

<body>
<h3>Join Chat</h3>

Room: <input id="room"><br><br>
User: <input id="user"><br><br>
<button id="join">Join</button>

<hr>

<div id="chat" style="display:none">
  <div id="msgs" style="height:300px;overflow:auto;border:1px solid #000"></div>
  <input id="text">
  <button id="send">Send</button>
</div>

<script>
let ws;
let room;
let user;

// âœ… FIX: explicitly get inputs
const roomInput = document.getElementById("room");
const userInput = document.getElementById("user");
const textInput = document.getElementById("text");
const msgs = document.getElementById("msgs");

function add(u, t) {
  const d = document.createElement("div");
  d.textContent = u + ": " + t;
  msgs.appendChild(d);
  msgs.scrollTop = msgs.scrollHeight;
}

document.getElementById("join").onclick = async () => {
  room = roomInput.value.trim();
  user = userInput.value.trim();
  if (!room || !user) {
    alert("Enter room and username");
    return;
  }

  document.getElementById("chat").style.display = "block";

  // Load history (non-blocking)
  try {
    const res = await fetch(
      `https://chat-server.skybaseofj2.workers.dev/history?room=${encodeURIComponent(room)}`
    );
    const history = await res.json();
    history.forEach(m => add(m.user, m.text));
  } catch (e) {
    console.warn("History load failed, continuing...");
  }

  // Open WebSocket
  ws = new WebSocket(
    `wss://chat-server.skybaseofj2.workers.dev/?room=${encodeURIComponent(room)}`
  );

  ws.onopen = () => {
    console.log("SOCKET OPEN");
  };

  ws.onmessage = e => {
    const m = JSON.parse(e.data);
    add(m.user, m.text);
  };

  ws.onerror = e => {
    console.error("WebSocket error", e);
  };
};

document.getElementById("send").onclick = () => {
  if (!ws || ws.readyState !== WebSocket.OPEN) return;
  if (!textInput.value.trim()) return;

  ws.send(JSON.stringify({
    user,
    text: textInput.value,
    time: Date.now()
  }));

  textInput.value = "";
};
</script>
</body>
</html>
