<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chat</title>

<style>
body {
  margin: 0;
  background: #0b141a;
  color: #fff;
  font-family: system-ui;
}
#app {
  max-width: 420px;
  height: 100vh;
  margin: auto;
  display: grid;
  grid-template-rows: auto 1fr auto;
}
header {
  background: #075e54;
  padding: 12px;
  text-align: center;
  font-weight: 600;
}
#join {
  padding: 12px;
}
#msgs {
  padding: 10px;
  overflow-y: auto;
}
.msg {
  margin: 6px 0;
  padding: 8px;
  border-radius: 8px;
  max-width: 75%;
}
.me {
  background: #dcf8c6;
  color: #000;
  margin-left: auto;
}
.other {
  background: #202c33;
}
#bar {
  display: flex;
  gap: 6px;
  padding: 8px;
  background: #1f2c34;
}
textarea {
  flex: 1;
  background: #1f2c34;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 8px;
}
button {
  background: #25d366;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  cursor: pointer;
}
</style>
</head>

<body>
<div id="app">
  <header id="title">Join Chat</header>

  <div id="join">
    <input id="room" placeholder="Room"><br><br>
    <input id="user" placeholder="Username"><br><br>
    <button id="joinBtn">Join</button>
  </div>

  <div id="msgs"></div>

  <div id="bar" style="display:none">
    <textarea id="text" placeholder="Type a message..."></textarea>
    <button id="sendBtn">âž¤</button>
  </div>
</div>

<script>
let ws = null;
let room = "";
let username = "";
let queue = []; // ðŸ”‘ message queue

const msgs = document.getElementById("msgs");
const textBox = document.getElementById("text");
const title = document.getElementById("title");
const joinBtn = document.getElementById("joinBtn");
const sendBtn = document.getElementById("sendBtn");

function addMsg(u, t) {
  const d = document.createElement("div");
  d.className = "msg " + (u === username ? "me" : "other");
  d.innerHTML = `<b>${u}</b><br>${t}`;
  msgs.appendChild(d);
  msgs.scrollTop = msgs.scrollHeight;
}

async function joinChat() {
  room = document.getElementById("room").value.trim();
  username = document.getElementById("user").value.trim();
  if (!room || !username) return;

  document.getElementById("join").style.display = "none";
  document.getElementById("bar").style.display = "flex";
  title.innerText = "Room: " + room;

  // Load stored messages
  const res = await fetch(
    `https://chat-server.skybaseofj2.workers.dev/history?room=${encodeURIComponent(room)}`
  );
  const history = await res.json();
  history.forEach(m => addMsg(m.user, m.text));

  // Connect WebSocket
  ws = new WebSocket(
    `wss://chat-server.skybaseofj2.workers.dev/?room=${encodeURIComponent(room)}`
  );

  ws.onopen = () => {
    // ðŸ”‘ Flush queued messages
    queue.forEach(m => ws.send(JSON.stringify(m)));
    queue = [];
  };

  ws.onmessage = e => {
    const m = JSON.parse(e.data);
    addMsg(m.user, m.text);
  };
}

function sendMessage() {
  const msgText = textBox.value.trim();
  if (!msgText) return;

  const payload = {
    user: username,
    text: msgText,
    time: Date.now()
  };

  // ðŸ”‘ ALWAYS add locally to UI
  addMsg(username, msgText);

  // ðŸ”‘ Send or queue
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(payload));
  } else {
    queue.push(payload);
  }

  textBox.value = "";
}

joinBtn.addEventListener("click", joinChat);
sendBtn.addEventListener("click", sendMessage);

textBox.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});
</script>
</body>
</html>
