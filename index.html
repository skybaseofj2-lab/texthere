<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Private Chat</title>

<style>
body {
  margin: 0;
  background: #0b141a;
  font-family: system-ui;
  color: #fff;
}

#app {
  max-width: 420px;
  height: 100vh;
  margin: auto;
  display: flex;
  flex-direction: column;
  background: #0b141a;
}

header {
  background: #075e54;
  padding: 14px;
  font-weight: 600;
  text-align: center;
}

#join {
  padding: 16px;
}

input, button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 8px;
  border: none;
}

input {
  background: #1f2c34;
  color: #fff;
}

button {
  background: #25d366;
  font-weight: 600;
  cursor: pointer;
}

#users {
  padding: 8px;
  font-size: 13px;
  background: #111b21;
  border-bottom: 1px solid #1f2c34;
}

#typing {
  font-size: 12px;
  padding-left: 10px;
  color: #aaa;
}

#msgs {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

.msg {
  max-width: 75%;
  padding: 10px;
  margin: 6px 0;
  border-radius: 10px;
  font-size: 14px;
}

.me {
  background: #dcf8c6;
  color: #000;
  margin-left: auto;
}

.other {
  background: #202c33;
}

#bar {
  display: flex;
  padding: 8px;
  background: #1f2c34;
  gap: 6px;
}

#text {
  flex: 1;
}
</style>
</head>

<body>
<div id="app">
  <header id="title">Private Chat</header>

  <div id="join">
    <input id="room" placeholder="Secret key"> </input>
    <input id="user" placeholder="Username"> </input>
    <button onclick="join()">Join Chat</button> 
  </div>

  <div id="chat" style="display:none">
    <div id="users"></div>
    <div id="typing"></div>
    <div id="msgs"></div>
    <div id="bar">
      <input id="text" placeholder="Message"> </input>
      <button onclick="send()">âž¤</button>
    </div>
  </div>
</div>

<script>
let ws, roomKey, myName;

/* ---------- Encryption ---------- */
async function getKey(secret) {
  const hash = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(secret));
  return crypto.subtle.importKey("raw", hash, "AES-GCM", false, ["encrypt","decrypt"]);
}

async function encrypt(text) {
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await getKey(roomKey);
  const enc = await crypto.subtle.encrypt(
    { name: "AES-GCM", iv },
    key,
    new TextEncoder().encode(text)
  );
  return { iv: [...iv], data: [...new Uint8Array(enc)] };
}

async function decrypt(payload) {
  const key = await getKey(roomKey);
  const dec = await crypto.subtle.decrypt(
    { name: "AES-GCM", iv: new Uint8Array(payload.iv) },
    key,
    new Uint8Array(payload.data)
  );
  return new TextDecoder().decode(dec);
}

/* ---------- UI ---------- */
function addMsg(user, text) {
  const d = document.createElement("div");
  d.className = "msg " + (user === myName ? "me" : "other");
  d.innerHTML = `<b>${user}</b><br>${text}`;
  msgs.appendChild(d);
  msgs.scrollTop = msgs.scrollHeight;
}

/* ---------- Join ---------- */
async function join() {
  roomKey = room.value.trim();
  myName = user.value.trim();
  if (!roomKey || !myName) return alert("Fill all fields");

  ws = new WebSocket(
    `wss://chat-server.skybaseofj2.workers.dev/?room=${encodeURIComponent(roomKey)}`
  );

  ws.onopen = async () => {
    join.style.display = "none";
    chat.style.display = "flex";
    title.innerText = "Room: " + roomKey;

    // Load history
    const r = await fetch(
      `https://chat-server.skybaseofj2.workers.dev/history?room=${roomKey}`
    );
    const history = await r.json();
    for (const m of history) {
      const txt = await decrypt(m.text);
      addMsg(m.user, txt);
    }
  };

  ws.onmessage = async e => {
    const m = JSON.parse(e.data);

    if (m.type === "users") {
      users.innerText = "Online: " + m.users.join(", ");
      return;
    }

    if (m.type === "typing") {
      typing.innerText = `${m.user} is typing...`;
      setTimeout(() => typing.innerText = "", 1000);
      return;
    }

    const txt = await decrypt(m.text);
    addMsg(m.user, txt);
  };
}

/* ---------- Send ---------- */
async function send() {
  if (!text.value) return;
  ws.send(JSON.stringify({
    user: myName,
    text: await encrypt(text.value)
  }));
  text.value = "";
}

text.oninput = () => {
  ws.send(JSON.stringify({ type: "typing", user: myName }));
};
</script>
</body>
</html>
