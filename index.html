<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Private Chat</title>

<style>
/* ---------- RESET ---------- */
* { box-sizing: border-box; }
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  font-family: system-ui;
  background: #0b141a;
  color: #fff;
}

/* ---------- APP ---------- */
#app {
  max-width: 420px;
  margin: auto;
  height: 100dvh;
  display: flex;
  flex-direction: column;
  background: #0b141a;
}

/* ---------- HEADER ---------- */
header {
  background: #075e54;
  padding: 14px;
  font-weight: 600;
  text-align: center;
  flex-shrink: 0;
}

/* ---------- JOIN ---------- */
#joinBox {
  padding: 16px;
}

input, button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 8px;
  border: none;
}

input {
  background: #1f2c34;
  color: #fff;
}

button {
  background: #25d366;
  font-weight: 600;
  cursor: pointer;
}

/* ---------- CHAT ---------- */
#chat {
  display: none;
  flex-direction: column;
  flex: 1;
  min-height: 0;
}

/* ---------- USERS / TYPING ---------- */
#users {
  padding: 6px 10px;
  font-size: 12px;
  background: #111b21;
  flex-shrink: 0;
}

#typing {
  font-size: 11px;
  padding: 4px 10px;
  color: #aaa;
  flex-shrink: 0;
}

/* ---------- MESSAGES ---------- */
#msgs {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

.msg {
  max-width: 75%;
  padding: 10px;
  margin: 6px 0;
  border-radius: 10px;
  font-size: 14px;
  word-wrap: break-word;
}

.me {
  background: #dcf8c6;
  color: #000;
  margin-left: auto;
}

.other {
  background: #202c33;
}

/* ---------- INPUT BAR ---------- */
#bar {
  display: flex;
  gap: 6px;
  padding: 8px;
  background: #1f2c34;
  flex-shrink: 0;
}

#text {
  flex: 1;
}
</style>
</head>

<body>
<div id="app">
  <header id="title">Private Chat</header>

  <!-- JOIN -->
  <div id="joinBox">
    <input id="roomInput" placeholder="Secret key">
    <input id="userInput" placeholder="Username">
    <button id="joinBtn">Join Chat</button>
  </div>

  <!-- CHAT -->
  <div id="chat">
    <div id="users"></div>
    <div id="typing"></div>
    <div id="msgs"></div>
    <div id="bar">
      <input id="text" placeholder="Message">
      <button id="sendBtn">➤</button>
    </div>
  </div>
</div>

<script>
/* ---------- DOM ---------- */
const roomInput = document.getElementById("roomInput");
const userInput = document.getElementById("userInput");
const joinBox = document.getElementById("joinBox");
const chatBox = document.getElementById("chat");
const msgs = document.getElementById("msgs");
const users = document.getElementById("users");
const typing = document.getElementById("typing");
const textInput = document.getElementById("text");
const title = document.getElementById("title");

/* ---------- STATE ---------- */
let ws, roomKey, myName;

/* ---------- ENCRYPTION ---------- */
async function getKey(secret) {
  const hash = await crypto.subtle.digest(
    "SHA-256",
    new TextEncoder().encode(secret)
  );
  return crypto.subtle.importKey("raw", hash, "AES-GCM", false, ["encrypt","decrypt"]);
}

async function encrypt(text) {
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await getKey(roomKey);
  const enc = await crypto.subtle.encrypt(
    { name: "AES-GCM", iv },
    key,
    new TextEncoder().encode(text)
  );
  return { iv: [...iv], data: [...new Uint8Array(enc)] };
}

async function decrypt(payload) {
  const key = await getKey(roomKey);
  const dec = await crypto.subtle.decrypt(
    { name: "AES-GCM", iv: new Uint8Array(payload.iv) },
    key,
    new Uint8Array(payload.data)
  );
  return new TextDecoder().decode(dec);
}

/* ---------- UI ---------- */
function addMsg(user, text) {
  const d = document.createElement("div");
  d.className = "msg " + (user === myName ? "me" : "other");
  d.innerHTML = `<b>${user}</b><br>${text}`;
  msgs.appendChild(d);
  msgs.scrollTop = msgs.scrollHeight;
}

/* ---------- JOIN ---------- */
async function joinChat() {
  roomKey = roomInput.value.trim();
  myName = userInput.value.trim();
  if (!roomKey || !myName) return alert("Fill all fields");

  ws = new WebSocket(
    `wss://chat-server.skybaseofj2.workers.dev/?room=${encodeURIComponent(roomKey)}`
  );

  ws.onopen = async () => {
    joinBox.style.display = "none";
    chatBox.style.display = "flex";
    title.innerText = "Room: " + roomKey;

    const r = await fetch(
      `https://chat-server.skybaseofj2.workers.dev/history?room=${encodeURIComponent(roomKey)}`
    );
    const history = await r.json();
    for (const m of history) {
      addMsg(m.user, await decrypt(m.text));
    }
  };

  ws.onmessage = async e => {
    const m = JSON.parse(e.data);

    if (m.type === "users") {
      users.innerText = "Online: " + m.users.join(", ");
      return;
    }

    if (m.type === "typing") {
      typing.innerText = `${m.user} is typing…`;
      setTimeout(() => typing.innerText = "", 1000);
      return;
    }

    addMsg(m.user, await decrypt(m.text));
  };
}

/* ---------- SEND ---------- */
async function sendMsg() {
  if (!textInput.value) return;
  ws.send(JSON.stringify({
    user: myName,
    text: await encrypt(textInput.value)
  }));
  textInput.value = "";
}

textInput.oninput = () => {
  if (ws) ws.send(JSON.stringify({ type: "typing", user: myName }));
};

document.getElementById("joinBtn").onclick = joinChat;
document.getElementById("sendBtn").onclick = sendMsg;
</script>
</body>
</html>
